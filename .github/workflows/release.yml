name: Build and Publish Release

on:
  push:
    tags:
      - 'v*' # Triggers on tags like v1.0.0, v2.1.3

jobs:
  build-and-release:
    runs-on: macos-latest
    permissions:
      contents: write # Required for creating the Release

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14' # Matches your local environment

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build App (py2app)
        run: |
          # Clean previous builds just in case
          rm -rf build dist
          # Run the build
          python setup.py py2app

      - name: Zip the Application
        run: |
          cd dist
          # Zip the .app bundle to make it downloadable/distributable
          zip -r Hattrix.zip Hattrix.app

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: dist/Hattrix.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Homebrew Tap
        uses: mislav/bump-homebrew-formula-action@v3
        with:
          # Name of the formula file (hattrix.rb)
          formula_name: hattrix

          # Your Tap Repository
          homebrew_tap: Malaber/homebrew-tap

          # IMPORTANT: Tell it where the file lives in the tap repo.
          # Since you followed standard structure, it's likely inside "Casks"
          cask_directory: Casks

          # The base branch of your tap repo
          base_branch: main

          # The URL to the new zip we just created in step 6
          download_url: https://github.com/Malaber/hattrix/releases/download/${{ github.ref_name }}/Hattrix.zip

          # Commit message for the tap repo
          commit_message: "Update hattrix to ${{ github.ref_name }}"
        env:
          COMMITTER_TOKEN: ${{ secrets.GH_TOKEN_FOR_TAP }}
